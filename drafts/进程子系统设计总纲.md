# EDSOS 进程子系统设计总纲

> **核心理念**：  
> **以 TS (Tree-Stacked) 节点为最小执行、调度与安全单元，构建一个结构化、可组合、可迁移、可验证的进程模型，在保持对任意二进制完全兼容的前提下，为可信程序提供强大性能与安全能力。**

---

## 一、核心抽象：TS 节点与 TS 树

### 1.1 TS 节点定义
- **本质**：一个**可调度的执行原子**，对应一段**逻辑完整、可独立执行的代码段**（不强制等于函数）
- **类型**：
  - `Control`：含完整执行上下文，可调度
  - `Root`：根节点，保存了完整的*背景*数据和资源，**自身不可被lift**也**不可被lift越过**，而且是 OS 代理节点
- **唯一标识**：`Root` 64 位标识（对应于PID），`Control` 无标识

### 1.2 TS 树结构
- **父子关系**：`parent_gpn` 定义作用域与权限继承
- **兄弟并行**：同级节点天然可并行执行
- **子树隔离**：错误/恶意行为无法逃逸出子树边界

---

## 二、进程子系统核心组件

| 组件 | 职责 | 关键技术 |
|------|------|--------|
| **TS 树管理器** | 创建/销毁 TS 节点，维护父子关系，处理 Lift/Push/Pop | 父子节点指针建立、引用计数、子树遍历 |
| **调度器** | 本地调度 + 全局协调 | CFS-style vruntime、亲和性调度、跨 PM 迁移 |
| **ABI 适配层** | 支持 EDSOS ABI 与通用 ABI（POSIX/Windows） | 编译器插桩、syscall 映射、守卫页监控 |
| **安全与能力引擎** | 内存隔离、权限控制、CFI | 内存子系统所有权、Capability 策略、控制流验证 |
| **兼容运行时** | 退化模式、自适应模式、容器映射 | 单节点执行、动态插桩、Pod → TS 树转换 |
| **驱动集成层** | 兼容 Linux 驱动 + 原生 EDSOS 驱动 | 驱动 shim、TS-aware 驱动接口 |

---

## 三、运行模式：三层能力交付

| 模式 | 触发条件 | 能力 | 安全 | 典型场景 |
|------|--------|------|------|--------|
| **L1：退化模式** | 任意闭源 ELF/EXE | 基础 syscall、单 TS 节点 | 内存子系统隔离 + Capability 限制 | 桌面软件、遗留系统 |
| **L2：自适应模式** | 通用 ABI + 启用分析 | 动态 TS 创建、热点结构化 | CFI 监控 + 行为检测 | 中小服务器、开源应用 |
| **L3：原生模式** | EDSOS ABI + 有效签名 | 完整 TS 树、Lift、迁移、协程 | 硬件强制 CFI + 侧信道抑制 | 超算、AI 集群、高安全服务 |

> **模式自动选择**：由根节点在加载时根据二进制元数据与系统策略决定。

---

## 四、安全模型：边界即安全

### 4.1 内存安全
- **访问验证**：检查访问的内存在直系祖节点链上
- **效果**：UAF、溢出、指针篡改无法跨节点破坏

### 4.2 控制流安全
- **CFI（控制流完整性）**：
  - 所有跳转必须到合法函数入口
  - 运行时桩验证目标地址
- **防 ROP/JOP**：无 gadget 链，无 raw 地址跳转

### 4.3 能力安全
- **Capability 模型**：
  - 根节点能力集描述了整个 TS 树的最大能力容许范围，各节点单独授予 capability
  - syscall 时检查 capability
- **最小权限**：默认无网络、无文件写入，按需授权

### 4.4 侧信道防护
- **时序模糊**：虚拟时钟

---

## 五、兼容性策略：拥抱生态，渐进替代

### 5.1 二进制兼容
- **POSIX 支持**：完整实现 `read/write/mmap/fork/exec` 等
- **Windows 支持**：通过 Wine-like syscall 映射

### 5.2 驱动兼容
- **短期**：Linux 驱动 shim 层（模拟 VFS/inode）
- **长期**：原生 `edsos_driver` 接口，支持 TS 节点回调

### 5.3 容器/沙箱映射
- `docker run` → 创建新 TS 树 + capability 限制
- 容器间隔离 = TS 树间隔离（强于 Linux namespace）

---

## 六、性能优化机制

| 机制 | 说明 |
|------|------|
| **TS 聚合** | 多函数合并为一节点，减少调度开销 |
| **懒分配** | 节点按需分配，内存稀疏映射 |
| **热路径内联** | 运行时桩在高频路径内联 |

---

## 七、开发者与用户支持

### 7.1 开发者工具链
- **编译器插件**：LLVM/GCC-EDSOS，生成 `.edsos_meta`
- **半自动优化器**：`edsos-optimize` 自动插入 TS 语义
- **调试支持**：`edsos-gdb` 可遍历 TS 树、查看节点状态

### 7.2 用户控制
- **能力策略**：图形界面设置“仅允许访问某目录”
- **资源监控**：`edsos-ps -t` 查看 TS 树结构
- **安全审计**：日志记录 capability 使用、异常行为

### 7.3 认证体系
- **自签名**：开发者私钥签名，集群策略信任
- **系统证书**：OS 厂商签发，用于驱动/系统服务
- **闭源友好**：无需披露源码，仅验证构建合法性
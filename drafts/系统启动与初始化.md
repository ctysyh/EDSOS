#### 系统启动与初始化

我们的一个重大约束就是**不得不为之的兼容性**，我们对于硬件的掌控仅仅局限于我们私有设计的DPU，主要的CPU、GPU、主板控制芯片等均需要我们为了它适配。
这其实也体现在了GVA和LVA的设计上：LVA就是标准的VA，而GVA是只有我们的DPU在用的、对于各类通用硬件来说**透明**的。GVA扩展成为128位而不是仅仅利用原本64位的剩余空间的原因正是兼容性，保留完整、标准的64位空间及其含义供通用硬件使用。但是我们同样能够利用仅有的DPU自由度，来设计出一个强大的统一访问协议。
具体到这里**物理存储资源的发现和管理**。由于EDSOS的特殊性和复杂性，这一步需要仔细分析和重构，BIOS/UEFI完成ACPI构建之后，**EDSOS对ACPI的解析过程**，以及**提供给驱动的`ioremap`内部处理过程**。
结合进程子系统的设计，驱动也是TS，并通过它的SPN和系统服务组件通信；我们可以设置一个专用的服务组件（可以命名为硬件资源管理组件，或者是否有更好的名字），用于处理和保存相关元信息，并且尤其处理热插拔。
我们尤其需要注意的一个地方就是*全局*与*局部*的表达含义，在EDSOS中，*全局*特指“受到同一个EDSOS实例管理的所有物理设备的集合”，而*局部*即特指“挂在同一个PCI root下的物理设备的集合”（这正是传统用法中的“全局”概念），前者可以是多个后者实例的并集。
这样来看，在基本的解析ACPI构建资源树阶段，这是由硬件资源管理组件来做的，它需要的不同之处就是要把多台PM的资源树拼接到一起，构成一个全局视图；全局视图自然需要主机编号标识，这部分**由我们的DPU驱动提供**，在各个物理主机分别加载各自的*EDSOS早期局部视图*来完成本机的基础资源识别之后，查询并启用DPU驱动，调用DPU并由各个DPU之间通过投票方式决选出一个或若干个（用于高可用场景下的冗余和纠错）EDSOS Meta-TS Root Node所在的物理机，以及为所有这些相连的物理机编号（即主机编号标识）；实际上各个物理主机自己并不需要知道和解析它的物理机编号，这部分内容和GVA一样是只保留在DPU中并由其解析的；从而，我们在某一台物理机中，私有地构建其全局的资源树。然后对于各个通用设备驱动，可以在此时检查是否有管理员在启动前的手动配置，否则按照默认策略，正常地在每个局部调用对应的驱动来初始化设备和映射MMIO；每个局部都直接使用物理地址，没有“内核虚拟地址”的概念，这正是EDSOS的微内核特征及其狭义内核的裸金属运行特征的体现，传统的“内核虚拟地址”分散到各个驱动TS和服务组件TS，它们使用的都是不同的进程页表。狭义内核（“硅中介层”）通常只绑定在各个CPU核心，不需要访问设备资源。
NixOS的设计我认为是一个非常有前景的方案，尤其是在EDSOS这个可以为每一个TS实例配置完全不同的硬件权限和兼容模式的操作系统中，提供一个明晰、简洁、易用的配置手段是非常重要的。比如这里，在机器启动时，BIOS完成初始化、载入操作系统时，前面已经提到此时载入的是**EDSOS早期局部视图**。这是一个过渡性的OS映像文件，它只运行在一个单一的物理机上。它在接过物理设备的管理权、完成基础的解析和初始化之后，可以**读取磁盘特定目录下的内容**，这个目录下可以包含一个类似于configuration.nix的文件，其中*可能*包含各项设置和配置信息、以及正式的系统映像所在的目录。比如说，对于桌面、单主机环境，可以在里面写各类简化日常配置、提高自动安全保护的设置，并列出图形化/窗口化框架的文件目录和设置，以及注明“不启用dpu_for_edsos”，这样哪怕真的连接了DPU也不会去加载它；对于服务器集群，除了各类配置信息，还可以注明“本机无正式系统映像”，从而直接加载DPU并等待存有正式系统映像的物理机加载完成后通过DPU远程注入所需的文件；当然这只是两个典型例子，还可以有很多不同的配置，包括**可以指定各个物理设备采用的驱动文件目录**，从而允许同时安装多个同功能驱动但只使用想要的那个。
此外，加载DPU、选定Meta-TS Root Node所在PM等用于初始化集群连接的工作也是在*EDSOS早期局部视图*运行期间完成的。
随着各项准备和初始化工作完成，*EDSOS早期局部视图*为每个CPU核心准备好硅中介层、并安排它们各自的第一个ready节点，自己即完成工作，退化为Meta-TS Root Node（对于选中的主机）或Meta-TS Root Proxy Node（对于其他主机）；这意味着，前面提到的系统配置文件、以及从DPU早期连接中获得的各类元信息，都属于Meta-TS Root Node或其代理的内容。**这里Meta-TS Root Node或其代理的内容是最基础的配置和元数据，它与HRMC管理的系统实际有哪些硬件设备、每个设备是什么、有多少资源等是完全不同的内容。**
之后就是正式搭建起整个Meta-TS骨架结构的过程，就是加载各个驱动TS和系统服务组件。再之后就可以开始运行各个应用程序了。
基于FPGA桥接PCIe通道的CPU间通信系统
让我们深入一种基于FPGA桥接PCIe通道的CPU间通信系统的软件实现。请你根据以下的详细内容，仔细分析。
1 背景
1.1 我们正在设计一种中等规模的高性能计算超节点。在现有的解决方案之上，我们正在探索前沿的解决方案，并尝试将其应用到研究和生产中.
1.2 我们的核心目标是构建一种跨主板的操作系统，使得超节点内的多台硬件在操作系统层面实现一体化。
1.3 目前已有的概念是“万事皆消息”，将所有的动态过程抽象为消息的生产和处理，为此我们已经设计出了一种无锁的消息环线，核心是邻接节点定向传递和节点私有消息队列；同时强调局部视角和自组织，不是从整体来调度庞大的系统，而是在每一个局部决断自己的行为、并且通过有限的状态域来约束整体行为。
1.4 为了实现这样一个复杂的愿景，我们现在研究跨主板的CPU通信方案，在前期可以代替以交换机为核心的网络结构实现更低的处理延迟和能耗，在未来可以成为分布式硬件统一操作系统的重要组成部分。

2 需求
2.1 保持两个CPU系统（主板）的总线隔离。
2.2 以定制协议的消息包格式传输数据。
2.3 通过DMA将数据直接写入目标CPU的本地内存的特定地址区域。
2.4 实现数据同步，特别是脏页/净页标记，尤其探索是否可能通过无锁方式实现。
2.5 作为进阶需求，我们希望这个系统能够在多线程调度等方面准备更多能力，包括跨设备的时钟兼容、动态指定目标内存地址、应用程序透明的跨CPU原子操作支持等，可以如何实现呢。特别地，让我们设想一个场景：某个进程展开了多个线程，分别在相连的两个CPU上执行；其中一个线程注册了一个操作系统的信号量等待在另一个CPU上执行的线程的执行结果；操作系统将这个信号量反映的逻辑关系翻译为上下文调度器的调度逻辑，当前CPU的上下文调度器将等待中的阻塞线程放入待绪队列、同时将阻塞线程的内存地址发送给另一个CPU，而另一个CPU的上下文调度器检查被等待的线程并将其放入就绪队列、同时注册一个回调；被等待的线程在执行完成时触发回调，向当前CPU发送一个消息告知等待中的线程可就绪，然后在某个缓冲区中缓存执行结果（**这里尤其重要，具体应该怎么做**）；当前CPU在进入内核时间时检查消息缓冲区专用内存获取可就绪指令，上下文调度器将待绪队列中的阻塞线程放入就绪队列，轮到线程执行时从缓冲区中读取所需的结果数据并正常执行。在这个场景中，如何具体地实现所有细节。
2.6 所有的需求实现中，将新的定制软硬件和现有的标准主板上的各个电气设备，尤其是IOMMU等，尽可能契合，并且尽量做到利用其已有特性增强性能，而非带来冲突。
2.7 考虑系统安全性，尤其是这样一个提供了标准化的DMA的系统，从性质出发应当只允许操作系统执行；此外还有哪些潜在漏洞？需要仔细考虑并从架构设计层面尽可能阻断风险。

3 现有实现
3.1 现有的通信系统硬件设计：利用较新一代CPU和主板的CXL2.0支持，。
3.2 无锁消息环线的更具体设计：首先定义逻辑节点，然后为每个节点分配其私有的环形消息队列缓存；当某个节点要发送消息时，在消息头中附加一个令牌和TTL，向逻辑环线的左右两个相邻逻辑节点的消息队列尾写入消息的两个副本；一个节点会轮询其消息队列，处理其中的所有消息，销毁TTL=0和满足其他指定条件的消息包，对于不满足销毁条件的消息包保持方向发送给下一个节点；所有节点轮值成为当值者，当值者负责管理所有共享资源，实现在任一时间点共享资源是单线程访问的；更具体的细节，包括故障处理等，不做展开。
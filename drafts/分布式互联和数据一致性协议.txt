# 分布式互联与数据一致性协议

三个核心层次的设计：**内存与互联模型**、**DPU 硬件架构**、**软件与驱动模型**共同构成一个**自组织、低成本、高性能的分布式计算基座**。

---

## 一、内存与互联模型：**分布式定制互联网络 + 双一致性协议**

### 关键特性概括

| 特性 | 说明 |
|------|------|
| **统一虚拟地址空间** | 所有节点共享同一地址空间，支持 `mmap(remote_addr)` |
| **位置感知语义** | 应用可通过 API 查询数据位置（本地 / 本机 / 邻机 / 远机四个层级） |
| **双一致性协议并存** | <ul><li>**路径缓存模型**：实现分布式原子操作</li><li>**所有权转移模型**：实现分布式锁操作</li></ul> |
| **无中心目录** | 一致性协调不依赖全局目录，而是通过：<br>• **路径缓存**（ref建立路径，写沿路径反向传播）<br>• **Invalid标记**（确保数据一致，防止过期读写） |
| **信息压缩与去冗余** | 同一页+同版本的多次访问 → 路径缓存合并，写广播仅发给活跃路径 |
| **拓扑自适应** | 支持任意互联拓扑（环、树、小世界图），通过图论优化直连数量与直径 |

> **本质**：用**访问轨迹**替代**静态目录**，实现“局部自组织 → 全局稳定”。

### 内存模型
存储单元分为四个距离层级：本地、本机、邻机、远机；而除了本地之外每个距离层级对应三种速度层级：内存、高速硬盘、低速磁盘，本地仅有近距内存层级。对于所有的内存和相当比例的高速磁盘，使用分页管理。采用128位全局虚拟地址索引空间（GVA），前64位为标识位、ref索引和机器索引、后64位为机内索引；同时在每台主机内，使用64位局部虚拟地址索引空间（LVA），完全复用标准的48/57位虚拟地址索引空间定义；GVA和LVA均支持大页；GVA和LVA之间在任一时刻、任一主机处是单射（但不一定满射）。
严格限制虚拟页的分配上限为物理容量，即对于每个主机，它任意时刻可索引的虚拟页的数量和总大小不能超过它的物理页数量和总大小。这就是说，虽然GVA是128位的，但是对于每个主机确实只需64位的LVA；LVA完全等同于现有规范中的VA，通过MMU直接映射为PA；主机内的LVA和对应的GVA之间的映射关系，由主机的DPU保存，不参与本机的访存过程，而是（通过编译器插桩方式）在访问共享页时触发旁路逻辑，将LVA及其所需的额外操作指令同步发送给DPU，由DPU负责执行。

### 路径缓存协议
虚拟内存页不是凭空出现的，它一定是由控制流的某个线程分配，或者某个进程分配并共享的，而这一定会发生在一个物理机上。考虑一个由处在物理机A中的线程A分配的虚拟页，其中的变量通过函数传参被线程B获取（ref），而线程B处在另一个物理机B中，这时这个虚拟页的元信息传播到物理机B中，物理机B需要在本机分配一个新虚拟页以接收其内容；这个新虚拟页的LVA和PA按正常逻辑内部分配，GVA的主要部分等于物理机A中的正本页的GVA、仅有ref索引部分不同（**ref索引的分配需要额外记录，或者特殊的分配逻辑**）。在ref过程中，起始和中间经过的DPU就会留下记录（即路径缓存）。
当线程B发生写操作时，写指令穿透（消息传播）到所有者（物理机A）持有的正本；假如还有有多个其他线程同时发生写操作，那么就由物理机A的DPU仲裁出顺序按序执行。接着物理机A的DPU把写指令的发生反向传播给所有ref这个虚拟页的其他物理机；这是通过直接调用它们在ref时留下的路径缓存实现的，即只需要以正本的GVA为key，在每个途径的DPU中查找路径缓存，然后根据缓存的路径来向继续传播，直到不再有更远的路径；对于少量数据，直接采用Write-Update更新副本；对于大量数据，采用Write-Invalidate，执行读指令时如果本地虚拟页标记了Invalid，需要重新同步数据。
ref的取消会在控制流中线程B终结或者更换物理位置时自动触发，发送特殊的消息包沿路删除对应的路径缓存。

> **特征**：开销较低；读操作在无竞争时直接读本地副本，高效快速、完全兼容；但可能写指令的传播稍微滞后，不能严格读到最新版本的内容（**指令传播延迟是接下来的重点优化指标**）；可以基于此构建快速页内原子操作/信号量操作。

### 所有权转移协议
与路径缓存协议相同地，每个内存页同一时刻只会有一个所有者；但是任何读写操作想要进行，都需要获取所有权。这是通过缺页中断实现的。考虑线程A要求分配了一个虚拟页之后，另一个物理机上的线程B要求所有权持有访问。在线程B要求之前，首先仍然需要通过路径缓存协议建立ref，这也是线程B能够得知这个虚拟页存在的原因；然后线程B（向物理机B的DPU）发出所有权要求指令，由于已经建立ref，指令按照缓存路径传播给物理机A（不删除缓存），然后仲裁；不论如何B最终被允许得到所有权，物理机A中这个虚拟页就被标记为缺页（在机内对LVA标记）、且在页表项的OS保留位中标记为“交换中”，物理机B中的ref副本页也标记为“交换中”（即临时锁定页面）；接着整个页的内容数据就传输给物理机B，直接覆盖在原先建立的ref副本所在的物理页中；完成之后，物理机A中的已失效旧正本的元数据跟物理机B的旧缓存副本的元数据交换，且交换的同时更改路径缓存中的方向和两个节点的性质标记；最后，物理机B拿到了完整的正本，物理机A拿到了完整的原属于物理机B的ref副本，路径缓存也完成了更新，将两个物理机中的对应LVA页表项也更新即完成了整个流程。总结包括发起、仲裁、内容传输、元数据更新四个步骤，指令传播两个来回（发起-回应、确认数据-确认完成）、内容传输单次发送。 
仲裁主要基于指令传播到达的先后顺序（包括自竞争指令）；只有多个指令在同一个时钟周期同时到达时，根据优先级、公平防饿、端口序号仲裁出归属；不论是否获得所有权，都会*立即*（固定的时钟周期数量）返回一个响应或提交一个异常；仲裁发生在当前所有者，当前所有者拥有最高的权限，可以将一个指定的寄存器置高来声明处于不可被换出状态，但是这个状态会在DPU内硬件计时、不可超出上限，“超出上限主机未响应”是一个触发报告主机故障的场景。
所有权协议与路径缓存协议完全兼容并存，仅在交换过程中需要让路径缓存协议的指令消息在发生交换的两个节点处等待交换完成。

> **特征**：开销和延迟相对较高，但是顺序和正确性严格保证；适合必须严格一致性的情况，可以基于此构建出锁操作。

### 互联节点抽象
每个物理机视为一个节点。物理机（PM）的定义是**可以独立连接一个PCIe DPU、拥有自己的内存并实现内存管理的物理单位**。主要包括安装在主板上的CPU（如果是单板双路CPU只能视为一个节点），可以包括有一定独立运行能力的GPU（但要求GPU能够独立与DPU开展交互）和其他集成电路。
每个节点拥有一个DPU，DPU承载了节点在集群中通信的所有能力，DPU是节点的代理。
DPU之间通过SerDes点对点连接。一个DPU只有有限的SerDes端口数量，在不直接对点连接的DPU之间需要通过其他DPU中继（这也是路径缓存存在的基础），通过优化每DPU端口数量和DPU之间的连接方式来达到最优的延迟-成本比。
**一个节点内部仍然很复杂，哪怕是单个CPU，也是有众多核心、众多内存；甚至可以是子互联网络。因此需要详细的设计来实现单节点多内源的指令合并和拆分。**

---

## 二、DPU 设计：**分布式 NoC 路由器 + 一致性引擎**

### 角色定义
DPU 不是简单的PCIe 桥接器，而是*分布式内存网络的智能路由器与节点代理*，承担原由 CPU 或专用互连硬件（如 NVSwitch）完成的关键任务。

### 功能模块

| 模块 | 功能描述 |
|------|--------|
| **PCIe Endpoint** | 对接本机 CPU/GPU |
| **消息解析器** | 识别请求类型（Load / Store / Atomic / Control Request） |
| **路径缓存（Path Cache）** | <ul><li>记录最近访问某内存页的路径（节点序列）</li><li>支持 LRU/TTL 老化</li><li>写操作时用于反向广播</li></ul> |
| **NoC 路由引擎** | <ul><li>基于目标地址或路径缓存，决定下一跳</li><li>支持多端口直连（如 4–8 个邻居）</li><li>可配置拓扑（硬件连接决定的静态路由表）</li></ul> |
| **一致性仲裁器** | 在所有权模型中，处理多节点并发请求，按优先级/时间戳仲裁 |

> **DPU = NoC Router + Memory Coherence Agent + Message Compressor**

### 基本要求
将所有通用热路径设计为无需缓存中断、在电路中信号连续传播完成处理逻辑，遇到复杂情况提请主机或同板高性能通用芯片解决，尽量避免消息因堆积而使用DPU缓存。

### 与主机（OS局部视图）的连接
<TODO>

---

## 三、软件模型：**OS 重写 + 编程抽象**

### 内核层（Kernel Space）

- 跨机进程（控制流）和内存（数据流）管理
- 根据内存页的分布开展线程调度或内存调度
- 提供128位GVA实现
- 提供集群内的统一时钟

### 驱动层（Driver Space）

| 组件 | 职责 |
|------|------|
| **DPU 驱动** | <ul><li>注册 PCIe 设备</li><li>提供 DMA 映射接口</li><li>处理中断/轮询 DPU 状态</li></ul> |
| **一致性协议栈** | <ul><li>封装路径缓存协议与所有权协议</li><li>提供 `atomic_cas_remote(addr, exp, new)` 等系统调用</li></ul> |

### 兼容性设计
- 支持RDMA RC Verbs API
- 支持其他主要的集群网络通信API
- 构建出一个完备、高效的原语系统及其实现，本身就是最好的兼容性

> 软件栈目标：简单应用无感使用，高性能应用精细控制

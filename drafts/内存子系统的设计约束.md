#### 内存子系统的设计约束

- **LVA 不能等于 Bus Address**

  - 应用程序使用的是编译期生成的指针（虚拟地址），这些指针在加载时由加载器分配到 TS 内的虚拟地址空间（LVA），而无法预知物理位置。DPU 需要通过应用传递的 LVA 来定位本地写入内容，因此 LVA 必须保留虚拟语义，不能直接等于物理地址。

- **LVA 必须在 TS 粒度上统一**

  - 同一个 TS 的所有节点共享同一虚拟地址空间，因此 LVA 的分配和映射必须在整个 TS 生命周期内保持一致。若按节点粒度分配 LVA，将破坏指针在 TS 内部的通用性和可传递性。

- **GVA 不能是全局单例地址空间**

  - 不同 TS（即不同“进程”）可能对相同 LVA 值映射到完全不同的物理资源，且各自独立进行虚拟页迁移（通过所有权协议）。

- **GVA 与 LVA 必须保持局部连续的一一对应**

  - 应用代码依赖指针算术。若 GVA 与 LVA 在局部范围内不保持相同的偏移关系，则无法在分布式场景中安全地将本地指针转换为 GVA 用于 DPU 通信，会破坏程序语义正确性。

- **DPU 必须能从 {TSID, LVA} 映射到 Bus Address**

  - DPU 接收的指令来自编译插桩，插桩传递的是 LVA（应用视角的地址）和 TSID（加载器内联）。DPU 需据此读取本机内存中被修改的内容，以执行一致性协议。因此，DPU 必须具备将 {TSID, LVA} 转换为实际物理位置（Bus Address）的能力。

- **页表必须按子树粒度维护副本**

  - TS 节点的作用域隔离要求：一个节点只能访问自身及其祖先的 VP。不同子树即使属于同一 TS，其作用域边界也不同，因此页表中 PTE 的“Present”状态必须差异化。若共享页表，则无法实现细粒度作用域控制。

- **页表切换不能依赖 CR3 切换（同子树内）**

  - 节点调度频率极高（微秒级），若每次切换都切换 CR3（即完整页表），TLB 会完全失效，预热成本过高。而同子树内节点共享大部分作用域，仅需增量更新 PTE 的可访问性。

- **DPU 指令必须由应用显式发出（插桩）**

  - DPU 无法监听或拦截普通内存访问（无 MMU 旁路机制，且不修改内存控制器）。因此，所有需要 DPU 参与的一致性操作（如通知写入）必须由应用代码在编译时显式插入指令，形成“主动协同”模型。

- **TSID 必须在 TS 创建时全局分配且不可变**

  - 不同的 TSID 对应不同的 GVA 空间，且 DPU 映射表、远程引用、一致性协议均以 TSID 为关键索引。若 TSID 可变或非全局唯一，将导致 GVA 冲突、DPU 查表错误、跨机通信混乱。

- **VP（虚拟页）是内存分配与迁移的基本单位**

  - 作用域隔离、所有权协议、DPU 映射注册均以 VP 为操作对象。若允许任意粒度（如字节级）迁移或共享，将导致元数据爆炸、一致性协议复杂度不可控。VP 作为对齐的、可命名（编号）的单元，是系统可扩展性的基础。

- **LVA 空间必须在 TS 生命周期内保持稳定**

  - 应用指针在 TS 运行期间长期有效。若 LVA 在 TS 运行中被回收，将导致悬空指针。因此，LVA 到物理资源的绑定可变（通过页表），但 LVA 本身的虚拟布局必须稳定。

- **LVA 空间的连续性要求对齐节点粒度**

  - 节点是应用程序执行的基本粒度，节点不会分割同一个对象实例；而节点间就像不同线程的栈一样互相的 LVA 大小关系没有任何意义。因此，LVA 空间的连续性要求对齐节点粒度，这是最小必要的连续性对齐粒度。

---

这些约束共同构成了 EDSOS 内存子系统的**设计边界**。它们源于：
- **应用语义需求**（指针、隔离、连续性）
- **硬件现实限制**（DPU 无监听能力、TLB 成本）
- **分布式一致性要求**（可迁移、可路由、可验证）

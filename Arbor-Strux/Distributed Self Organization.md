<!--
SPDX-FileCopyrightText: © 2025-2026 Bib Guake
SPDX-License-Identifier: CC-BY-4.0
-->

# **Distributed-Self-Organization**

> **在什么条件下，一个仅依赖局部交互、无全局协调的分布式系统，能通过自组织机制涌现出全局稳定性**

---

## 1. **问题形式化**

我们定义一个 **分布式自组织系统（Distributed Self-Organizing System, DSOS）** 为六元组：

\[
\mathcal{S} = (V, E, \mathcal{M}, \Phi, \Psi, \mathcal{R})
\]

其中：

- \( V \)：节点集合（\( |V| = N \)），每个节点 \( v \in V \) 对应一台物理机（含 DPU）。
- \( E \subseteq V \times V \)：**静态物理拓扑**，由 SerDes 直连与中继路径构成，形成无向图 \( G = (V, E) \)。
- \( \mathcal{M} \)：**共享状态空间**，此处为全局虚拟地址空间（GVA）中所有页的集合，每个页 \( p \in \mathcal{M} \) 有唯一标识。
- \( \Phi: V \to 2^{\mathcal{M}} \)：**局部状态映射**，\( \Phi(v) \) 表示节点 \( v \) 当前“接触过”的页（即持有副本或路径缓存）。
- \( \Psi: \mathcal{M} \to V \)：**所有权函数**，\( \Psi(p) = v \) 表示页 \( p \) 的当前所有者为 \( v \)。
- \( \mathcal{R} \)：**局部交互规则集**，包括：
  - **Ref 规则**：当 \( v \) 首次访问 \( p \)，若 \( p \notin \Phi(v) \)，则沿 \( G \) 向 \( \Psi(p) \) 建立路径，并将 \( p \in \Phi(v) \)。
  - **Write 规则**：写操作触发“写传播”：从 \( \Psi(p) \) 沿所有已建立的 ref 路径反向广播。
  - **Ownership Transfer 规则**：请求者 \( v \) 向 \( \Psi(p) \) 发起请求；若满足前置条件（无本地写、非热路径），则转移所有权并更新 \( \Psi(p) \leftarrow v \)。

定义一个**稳定的DSOS**为满足下述条件：
<TODO>

定义一个**有序的DSOS**为满足下述条件：
<TODO>
- **一致性（Consistency）**：所有副本最终反映同一状态序列。
- **收敛性（Convergence）**：系统状态随时间趋于稳定（如路径缓存不再频繁变更）。
- **鲁棒性（Robustness）**：节点失效后，系统可恢复一致性。

---

### 2. **自组织的数学刻画**

> **自组织 = 系统通过内部局部动力学，在无外部指令下，从无序/低序态演化至有序/高序态。**

我们引入 **局部交互图（Local Interaction Graph, LIG）** 来建模动态依赖：

- 对每个页 \( p \)，定义其 **ref 图** \( G_p = (V_p, E_p) \)，其中：
  - \( V_p = \{ v \in V \mid p \in \Phi(v) \} \)
  - \( E_p \) 由 ref 建立时的路径缓存决定（有向，指向所有者）
- 则系统整体状态为 \( \bigcup_{p \in \mathcal{M}} G_p \)

> **自组织过程 = \( \{G_p\} \) 随时间演化，趋向稀疏、稳定、低直径结构。**

---

### 3. **稳定性涌现的充分条件**

我们提出以下 **三个理论条件**，若满足，则系统能涌现出全局稳定性：

#### **条件 1：局部状态有限性（Finite Local State）**
> 每个节点 \( v \) 的 \( \Phi(v) \) 大小受物理内存限制（即 \( |\Phi(v)| \leq M_{\text{phys}} \)）。

- **作用**：防止状态爆炸，保证系统可收敛。
- **数学后果**：每个 \( G_p \) 的节点度有界，系统状态空间有限 → **必然存在不动点或循环**。

#### **条件 2：交互规则单调性（Monotonic Interaction）**
> 所有规则满足 **信息单调性**：一旦建立 ref 路径，不会因新访问而“撤销”已有路径（除非显式取消）；所有权转移是单向的（从当前所有者到请求者）。

- **形式化**：定义偏序 \( \preceq \) 于系统状态空间，若 \( S_1 \preceq S_2 \) 表示 \( S_2 \) 包含 \( S_1 \) 的所有路径和所有权关系。
- 若规则满足：\( S \xrightarrow{\text{rule}} S' \implies S \preceq S' \)，则系统是**单调系统**。
- **后果**：根据 **Tarski 不动点定理**，单调系统在有限格上必收敛至最小不动点。

> ✅ 路径缓存的“建立但不主动删除”、所有权的“单向转移”均满足此条件。

#### **条件 3：拓扑连通性与信息传播完备性（Topological Connectivity）**
> 物理图 \( G = (V, E) \) 是**连通的**，且对任意 \( p \)，初始所有者 \( \Psi_0(p) \) 可通过 \( G \) 到达任意节点。

- **作用**：保证任何页的访问请求最终能到达所有者。
- **强化条件（可选）**：\( G \) 的直径 \( D < \infty \)，则传播延迟有界。

---

### 4. **稳定性形式化定义与证明思路**

我们定义 **全局稳定性** 为以下性质的组合：

#### **(a) 最终一致性（Eventual Consistency）**
> 对任意页 \( p \)，所有副本最终反映同一操作序列（在无新写入后）。

- **证明思路**：
  - 写操作由所有者序列化（仲裁器保证 FIFO）。
  - 写传播沿 ref 路径广播（路径缓存保证覆盖所有副本）。
  - 由于路径一旦建立即有效，且写操作有限 → 所有副本最终接收相同序列。

#### **(b) 路径收敛（Path Convergence）**
> 对高频访问的页 \( p \)，其 ref 图 \( G_p \) 在有限时间内停止变更（除因节点失效）。

- **证明思路**：
  - 由条件 1，每个节点最多缓存 \( M \) 个页。
  - 高频页 \( p \) 被反复访问 → 其 ref 路径被反复使用 → LRU/TTL 机制保留路径。
  - 低频页路径老化删除 → \( G_p \) 稀疏化。
  - 系统进入“稳态”：仅热页有活跃路径。

#### **(c) 故障鲁棒性（Failure Robustness）**
> 若节点 \( v \) 失效，其持有的页副本可通过租期超时或 ACK 缺失被检测，所有权可迁移。

- **机制**：租期（Lease）提供**有界失效检测**。
  - 若 \( v \) 是所有者且失效，则请求者在租期过期后可强制迁移（MIGRATE hint）。
  - 若 \( v \) 是副本持有者，其失效不影响一致性（写传播仅需到达活跃副本）。

---

### 5. **与经典理论的对比**

| 理论框架 | 本系统差异 |
|--------|----------|
| **FLP 不可能定理** | 不要求所有节点存活下的强一致性；允许租期+最终一致性 |
| **CAP 定理** | 选择 **AP + 有界延迟的 C**：网络分区时，分区内保持可用与一致，分区恢复后通过所有权仲裁合并 |
| **Gossip 协议** | Gossip 是随机传播；本系统是**确定性路径传播**，开销更低、延迟可预测 |
| **Cellular Automata** | CA 规则均匀；本系统规则**语义驱动**（按页、按访问模式异构） |

---

### 6. **结论：自组织稳定性的涌现定理（初步）**

> **定理（DSOS 稳定性）**：  
> 给定一个分布式系统 \( \mathcal{S} = (V, E, \mathcal{M}, \Phi, \Psi, \mathcal{R}) \)，若满足：  
> (1) 局部状态有限，  
> (2) 交互规则单调，  
> (3) 物理拓扑连通，  
> 则系统在无持续写入下，必在有限时间内达到**路径收敛**状态，且所有页满足**最终一致性**；在有界节点失效下，系统可通过租期机制恢复一致性。

> **注**：此定理可进一步形式化为 **TLA+** 或 **Coq** 规范，作为 EDSOS 正确性基础。

---

### 7. **对 EDSOS 设计的指导意义**

- **必须保证**：物理拓扑连通（部署约束）
- **应强化**：规则单调性（避免路径“震荡”）
- **可优化**：通过小世界拓扑降低直径 → 加速收敛
- **需监控**：路径缓存命中率、租期超时率 → 作为系统“有序度”指标

---

此分析将 **0.2 Distributed-Self-Organization** 从工程描述提升为**可证明的理论框架**，为 EDSOS 的“无中心一致性”提供坚实的数学基础。后续可在此基础上构建形式化模型检查（如用 TLA+ 验证仲裁器+路径缓存的组合行为）。
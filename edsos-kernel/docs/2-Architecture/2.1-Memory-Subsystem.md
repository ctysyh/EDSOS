<!--
SPDX-FileCopyrightText: © 2025-2026 Bib Guake
SPDX-License-Identifier: LGPL-3.0-or-later
-->

# 2.1 Memory Subsystem

---

> v0.1.3-drafting

---

- [2.1 Memory Subsystem](#21-memory-subsystem)
  - [2.1.1 Memory Manager Architecture](#211-memory-manager-architecture)
  - [2.1.2 物理资源枚举与控制](#212-物理资源枚举与控制)
  - [2.1.3 内存映射管理](#213-内存映射管理)
    - [2.1.3.1 新节点实例创建时的行为](#2131-新节点实例创建时的行为)
    - [2.1.3.2 不同节点实例中含有同一绑定链上字段时的行为](#2132-不同节点实例中含有同一绑定链上字段时的行为)
  - [2.1.4 内存压力管理](#214-内存压力管理)
    - [2.1.4.1 驱逐策略](#2141-驱逐策略)
    - [2.1.4.2 转移存储](#2142-转移存储)
    - [2.1.4.3 资源硬边界](#2143-资源硬边界)
  - [2.1.5 调试与可观测性](#215-调试与可观测性)
    - [2.1.5.1 PP 层接口](#2151-pp-层接口)
    - [2.1.5.2 VP 层接口](#2152-vp-层接口)
    - [2.1.5.3 AS/Node 层接口](#2153-asnode-层接口)
    - [2.1.5.4 全局接口](#2154-全局接口)
    - [2.1.5.5 安全验证](#2155-安全验证)


---

## 2.1.1 Memory Manager Architecture

- 内存管理组件作为硅中介层的重要组成部分，其自身运行在裸金属上。
- 它主要是以回调形式由执行子系统的调度器执行。
- 它主要包括对物理存储资源的枚举与控制、对各AS实例虚拟内存的管理及对各节点实例访存的控制、对数据一致性协议的硬件功能调用与面向应用程序的提供。

---

## 2.1.2 物理资源枚举与控制

---

## 2.1.3 内存映射管理

### 2.1.3.1 新节点实例创建时的行为

当一个节点实例被`psh`的时候，它是有上下文的。这个操作是在父节点内实行的，因此它首先在`code`里边提供新节点的template，从而得出需要的虚拟空间和物理空间各有多少；内存子系统负责分配空间、处理静态（立即）的映射（即`publ`和`priv`）并返回结果。返回内容中需要包括*节点页表块基址*，即节点它的虚拟地址是连续的，因此这些VP的页表也是连续的，这一段的起始地址即称为节点页表块基址，就是`node_info`里边的`pt_base_pa`，Native-ISA对此提供支持。

### 2.1.3.2 不同节点实例中含有同一绑定链上字段时的行为

处于直系祖孙链上不同节点实例之间，往往会通过`ance`关键字声明动态（延迟）实例化的字段，并在父子关系的建立中指定这些字段的间接实例化。此时，

---

## 2.1.4 内存压力管理

### 2.1.4.1 驱逐策略
- **单位**：节点（因 VP 绑定于节点）
- **热度预测**：
  - 就绪队列等待时间
  - 事件阻塞时长
  - AS 树拓扑邻近性
- **动作**：调度器主动解除 VP 对 PP 的盛装

---

### 2.1.4.2 转移存储
- **SSD PP**：PPSUC 包含高速磁盘可用
- **流程**：调度器将 VP 迁移到 SSD PP → 访问时按需重迁移

---

### 2.1.4.3 资源硬边界
- **抛出失败**：无空闲 PP 且迁移超时 → 返回“内存不足”
- **禁止跨 PM 分配**

---

## 2.1.5 调试与可观测性

### 2.1.5.1 PP 层接口
- `pp_status(pp_id)`
- `pp_snapshot(gpa_range)`

---

### 2.1.5.2 VP 层接口
- `vp_info(tsid, lva)`
- `vp_trace_start/stop(tsid, lva)`

---

### 2.1.5.3 AS/Node 层接口
- `ts_layout(tsid)`
- `ctrn_refs(ctrn_lva)`
- `node_scope(node_lva)`

---

### 2.1.5.4 全局接口
- `dpu_message_log(pm_id)`
- `scheduler_decision_log(core_id)`
- `chain_bus_stats()`

---

### 2.1.5.5 安全验证
- `check_lva_overflow(asid)`
- `verify_vp_consistency(gva)`
